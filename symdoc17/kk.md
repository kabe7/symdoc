---
title: Network Optimisation
layout: page
---



#力学モデルを用いたグラフ描画

グラフを描画する際、頂点の配置をどのようにするかということは視覚的な理解に大きな影響を及ぼす。
本記事では、グラフの頂点と辺に仮想的な力を割り当て、力学的エネルギーの低い安定状態を探して
グラフのレイアウトを求める**kamada-kawai**法を用いる。



##力学的エネルギーの定義

まず、グラフの全頂点がばねで結ばれていると仮定すると、系全体の力学的エネルギーは次で表される。
$$E = \frac{1}{2} \sum_{\substack{0 \leq i \leq n - 1\\0 \leq j \leq n - 1}} \frac{k_{i,j}}{2} \left(\sqrt{\left(P_{i,0} - P_{j,0}\right)^{2} + \left(P_{i,1} - P_{j,1}\right)^{2}} - l_{i,j}\right)^{2}$$
ただし、$P_{i,d}$はi番目の頂点の座標の第$j$成分、$k_{i,j},l_{i,j}$はそれぞれ頂点$i$と頂点$j$の間のばね定数、自然長とする。

$k_{i,j},l_{i,j}$は、$d_{i,j}$を頂点$i$と頂点$j$を結ぶ最短経路の長さとして
$$k_{i,j} = K / d_{i,j}^2 (i \neq j) \ \  0(i = j)$$
$$l_{i,j} = L \times d_{i,j}$$
で定める($K,L$は定数)。

$d_{i,j}$は**Warshall-Floyd**のアルゴリズムにより求めることができる。



##エネルギーの最小化

例として、頂点数がn,次元が2であるときを考える。
力学的エネルギーが最小になる点では、$gradE = \vec 0$が成り立つ。すなわち、変数が$2 n$個ある$2 n$本の非線型連立方程式を解けばよいのだが、これを解析的に解くのは難しい。
そこで、次のような方法で近似解を求める。

1:まず、特定の頂点1つに着目し、他の頂点の位置を固定する。

2:そして、Newton-Raphson法により選んだ頂点の座標について力学的エネルギー$E$の最小化を行う。

3:着目する頂点を変えて1,2を繰り返す。

4:$\|gradE\|$が十分小さくなったら終了、その時の座標の値を解とする。

以下で、その具体的な方法について述べる。

##近似解の導出

選んだ頂点をmとし、その座標を$P_m = \left(\begin{matrix}x_{0} & x_{1}\end{matrix}\right)$とする。つまり$\left(\begin{matrix}P_{m,0} & P_{m,1}\end{matrix}\right) = \left(\begin{matrix}x_{0} & x_{1}\end{matrix}\right)$である。

このときNewton-Raphson法による反復式は、変数を$\left(\begin{matrix}x_{0} & x_{1}\end{matrix}\right)$としたときのEの1次導関数を$J_m$、2次導関数を$H_m$として
$$H_m \left(\begin{matrix}\Delta x_{0}\\\Delta x_{1}\end{matrix}\right) = -J_m$$
により表される。
これは2元連立1次方程式となり容易に解けて変位$\Delta P_i = \left(\begin{matrix}\Delta x_{0} & \Delta x_{1}\end{matrix}\right)$が求められるので、$P_i = P_i + \Delta P_i$により座標を更新する。
以上を繰り返し、変位が十分小さくなったら操作を終了する。

例えば、$m=0$だとすると、反復式は
$$\left(\begin{matrix}\sum_{i=1}^{n} \left(1 - \frac{l_{i,0}}{\sqrt{P_{i,0}^{2} - 2 P_{i,0} x_{0} + P_{i,1}^{2} - 2 P_{i,1} x_{1} + x_{0}^{2} + x_{1}^{2}}} + \frac{P_{i,0}^{2} l_{i,0}}{\left(P_{i,0}^{2} - 2 P_{i,0} x_{0} + P_{i,1}^{2} - 2 P_{i,1} x_{1} + x_{0}^{2} + x_{1}^{2}\right)^{\frac{3}{2}}} - \frac{2 P_{i,0} l_{i,0} x_{0}}{\left(P_{i,0}^{2} - 2 P_{i,0} x_{0} + P_{i,1}^{2} - 2 P_{i,1} x_{1} + x_{0}^{2} + x_{1}^{2}\right)^{\frac{3}{2}}} + \frac{l_{i,0} x_{0}^{2}}{\left(P_{i,0}^{2} - 2 P_{i,0} x_{0} + P_{i,1}^{2} - 2 P_{i,1} x_{1} + x_{0}^{2} + x_{1}^{2}\right)^{\frac{3}{2}}}\right) k_{i,0} & \sum_{i=1}^{n} \left(\frac{P_{i,0} P_{i,1} l_{i,0}}{\left(P_{i,0}^{2} - 2 P_{i,0} x_{0} + P_{i,1}^{2} - 2 P_{i,1} x_{1} + x_{0}^{2} + x_{1}^{2}\right)^{\frac{3}{2}}} - \frac{P_{i,0} l_{i,0} x_{1}}{\left(P_{i,0}^{2} - 2 P_{i,0} x_{0} + P_{i,1}^{2} - 2 P_{i,1} x_{1} + x_{0}^{2} + x_{1}^{2}\right)^{\frac{3}{2}}} - \frac{P_{i,1} l_{i,0} x_{0}}{\left(P_{i,0}^{2} - 2 P_{i,0} x_{0} + P_{i,1}^{2} - 2 P_{i,1} x_{1} + x_{0}^{2} + x_{1}^{2}\right)^{\frac{3}{2}}} + \frac{l_{i,0} x_{0} x_{1}}{\left(P_{i,0}^{2} - 2 P_{i,0} x_{0} + P_{i,1}^{2} - 2 P_{i,1} x_{1} + x_{0}^{2} + x_{1}^{2}\right)^{\frac{3}{2}}}\right) k_{i,0}\\\sum_{i=1}^{n} \left(\frac{P_{i,0} P_{i,1} l_{i,0}}{\left(P_{i,0}^{2} - 2 P_{i,0} x_{0} + P_{i,1}^{2} - 2 P_{i,1} x_{1} + x_{0}^{2} + x_{1}^{2}\right)^{\frac{3}{2}}} - \frac{P_{i,0} l_{i,0} x_{1}}{\left(P_{i,0}^{2} - 2 P_{i,0} x_{0} + P_{i,1}^{2} - 2 P_{i,1} x_{1} + x_{0}^{2} + x_{1}^{2}\right)^{\frac{3}{2}}} - \frac{P_{i,1} l_{i,0} x_{0}}{\left(P_{i,0}^{2} - 2 P_{i,0} x_{0} + P_{i,1}^{2} - 2 P_{i,1} x_{1} + x_{0}^{2} + x_{1}^{2}\right)^{\frac{3}{2}}} + \frac{l_{i,0} x_{0} x_{1}}{\left(P_{i,0}^{2} - 2 P_{i,0} x_{0} + P_{i,1}^{2} - 2 P_{i,1} x_{1} + x_{0}^{2} + x_{1}^{2}\right)^{\frac{3}{2}}}\right) k_{i,0} & \sum_{i=1}^{n} \left(1 - \frac{l_{i,0}}{\sqrt{P_{i,0}^{2} - 2 P_{i,0} x_{0} + P_{i,1}^{2} - 2 P_{i,1} x_{1} + x_{0}^{2} + x_{1}^{2}}} + \frac{P_{i,1}^{2} l_{i,0}}{\left(P_{i,0}^{2} - 2 P_{i,0} x_{0} + P_{i,1}^{2} - 2 P_{i,1} x_{1} + x_{0}^{2} + x_{1}^{2}\right)^{\frac{3}{2}}} - \frac{2 P_{i,1} l_{i,0} x_{1}}{\left(P_{i,0}^{2} - 2 P_{i,0} x_{0} + P_{i,1}^{2} - 2 P_{i,1} x_{1} + x_{0}^{2} + x_{1}^{2}\right)^{\frac{3}{2}}} + \frac{l_{i,0} x_{1}^{2}}{\left(P_{i,0}^{2} - 2 P_{i,0} x_{0} + P_{i,1}^{2} - 2 P_{i,1} x_{1} + x_{0}^{2} + x_{1}^{2}\right)^{\frac{3}{2}}}\right) k_{i,0}\end{matrix}\right)\left(\begin{matrix}\Delta x_{0}\\\Delta x_{1}\end{matrix}\right) = -\left(\begin{matrix}\sum_{i=1}^{n} \left(- P_{i,0} + x_{0} + \frac{P_{i,0} l_{i,0}}{\sqrt{P_{i,0}^{2} - 2 P_{i,0} x_{0} + P_{i,1}^{2} - 2 P_{i,1} x_{1} + x_{0}^{2} + x_{1}^{2}}} - \frac{l_{i,0} x_{0}}{\sqrt{P_{i,0}^{2} - 2 P_{i,0} x_{0} + P_{i,1}^{2} - 2 P_{i,1} x_{1} + x_{0}^{2} + x_{1}^{2}}}\right) k_{i,0}\\\sum_{i=1}^{n} \left(- P_{i,1} + x_{1} + \frac{P_{i,1} l_{i,0}}{\sqrt{P_{i,0}^{2} - 2 P_{i,0} x_{0} + P_{i,1}^{2} - 2 P_{i,1} x_{1} + x_{0}^{2} + x_{1}^{2}}} - \frac{l_{i,0} x_{1}}{\sqrt{P_{i,0}^{2} - 2 P_{i,0} x_{0} + P_{i,1}^{2} - 2 P_{i,1} x_{1} + x_{0}^{2} + x_{1}^{2}}}\right) k_{i,0}\end{matrix}\right) $$
となる。

選んだ頂点の最適化が終わったら、別な頂点を選んで上記の最適化を繰り返す。
$max_i \sqrt{\left(\frac{d}{d P_{i,0}} E{\left (P_{i,0} \right )}\right)^{2} + \left(\frac{d}{d P_{i,1}} E{\left (P_{i,1} \right )}\right)^{2}}$が十分小さくなったら更新を終了してその時の座標を力学的エネルギー$E$が最小となる解とする。



##グラフdouble_triangleの描画

頂点を['0', '1', '2', '3', '4', '5']、隣接する点のリストを["['2', '3']", "['4', '5']", "['0', '3', '5']", "['0', '2']", "['1', '5']", "['1', '2', '4']"]とすると、最短経路行列$D$,ばね定数行列$K$,自然長行列$L$は次のようになる。
$$D = \left(\begin{matrix}0.0 & 3.0 & 1.0 & 1.0 & 3.0 & 2.0\\3.0 & 0.0 & 2.0 & 3.0 & 1.0 & 1.0\\1.0 & 2.0 & 0.0 & 1.0 & 2.0 & 1.0\\1.0 & 3.0 & 1.0 & 0.0 & 3.0 & 2.0\\3.0 & 1.0 & 2.0 & 3.0 & 0.0 & 1.0\\2.0 & 1.0 & 1.0 & 2.0 & 1.0 & 0.0\end{matrix}\right),K = \left(\begin{matrix}0.0 & 1.11111111111111 & 10.0 & 10.0 & 1.11111111111111 & 2.5\\1.11111111111111 & 0.0 & 2.5 & 1.11111111111111 & 10.0 & 10.0\\10.0 & 2.5 & 0.0 & 10.0 & 2.5 & 10.0\\10.0 & 1.11111111111111 & 10.0 & 0.0 & 1.11111111111111 & 2.5\\1.11111111111111 & 10.0 & 2.5 & 1.11111111111111 & 0.0 & 10.0\\2.5 & 10.0 & 10.0 & 2.5 & 10.0 & 0.0\end{matrix}\right),L = \left(\begin{matrix}0.0 & 30.0 & 10.0 & 10.0 & 30.0 & 20.0\\30.0 & 0.0 & 20.0 & 30.0 & 10.0 & 10.0\\10.0 & 20.0 & 0.0 & 10.0 & 20.0 & 10.0\\10.0 & 30.0 & 10.0 & 0.0 & 30.0 & 20.0\\30.0 & 10.0 & 20.0 & 30.0 & 0.0 & 10.0\\20.0 & 10.0 & 10.0 & 20.0 & 10.0 & 0.0\end{matrix}\right)$$
このとき、円周上に並べた頂点からkamada-kawai法により頂点座標の最適化を行なうと、次のようになる。
$$P = \left(\begin{matrix}-8.77208279962894 & -5.29446908003263\\12.9512046492833 & 15.3686801822484\\-2.65225621175079 & 2.89643427341546\\-12.8434386880317 & 3.722525864464\\17.0222086631959 & 6.35156426510948\\6.83100383320914 & 7.17809368168207\end{matrix}\right)$$

プロットした画像は次のようになる。

![最適化前](pics/double_triangle_before.png)
![最適化後](pics/double_triangle_after.png)




##グラフcubeの描画

頂点を['0', '1', '2', '3', '4', '5', '6', '7']、隣接する点のリストを["['1', '3', '4']", "['0', '2', '5']", "['1', '3', '6']", "['0', '2', '7']", "['0', '5', '7']", "['1', '4', '6']", "['2', '5', '7']", "['3', '4', '6']"]とすると、最短経路行列$D$,ばね定数行列$K$,自然長行列$L$は次のようになる。
$$D = \left(\begin{matrix}0.0 & 1.0 & 2.0 & 1.0 & 1.0 & 2.0 & 3.0 & 2.0\\1.0 & 0.0 & 1.0 & 2.0 & 2.0 & 1.0 & 2.0 & 3.0\\2.0 & 1.0 & 0.0 & 1.0 & 3.0 & 2.0 & 1.0 & 2.0\\1.0 & 2.0 & 1.0 & 0.0 & 2.0 & 3.0 & 2.0 & 1.0\\1.0 & 2.0 & 3.0 & 2.0 & 0.0 & 1.0 & 2.0 & 1.0\\2.0 & 1.0 & 2.0 & 3.0 & 1.0 & 0.0 & 1.0 & 2.0\\3.0 & 2.0 & 1.0 & 2.0 & 2.0 & 1.0 & 0.0 & 1.0\\2.0 & 3.0 & 2.0 & 1.0 & 1.0 & 2.0 & 1.0 & 0.0\end{matrix}\right),K = \left(\begin{matrix}0.0 & 10.0 & 2.5 & 10.0 & 10.0 & 2.5 & 1.11111111111111 & 2.5\\10.0 & 0.0 & 10.0 & 2.5 & 2.5 & 10.0 & 2.5 & 1.11111111111111\\2.5 & 10.0 & 0.0 & 10.0 & 1.11111111111111 & 2.5 & 10.0 & 2.5\\10.0 & 2.5 & 10.0 & 0.0 & 2.5 & 1.11111111111111 & 2.5 & 10.0\\10.0 & 2.5 & 1.11111111111111 & 2.5 & 0.0 & 10.0 & 2.5 & 10.0\\2.5 & 10.0 & 2.5 & 1.11111111111111 & 10.0 & 0.0 & 10.0 & 2.5\\1.11111111111111 & 2.5 & 10.0 & 2.5 & 2.5 & 10.0 & 0.0 & 10.0\\2.5 & 1.11111111111111 & 2.5 & 10.0 & 10.0 & 2.5 & 10.0 & 0.0\end{matrix}\right),L = \left(\begin{matrix}0.0 & 10.0 & 20.0 & 10.0 & 10.0 & 20.0 & 30.0 & 20.0\\10.0 & 0.0 & 10.0 & 20.0 & 20.0 & 10.0 & 20.0 & 30.0\\20.0 & 10.0 & 0.0 & 10.0 & 30.0 & 20.0 & 10.0 & 20.0\\10.0 & 20.0 & 10.0 & 0.0 & 20.0 & 30.0 & 20.0 & 10.0\\10.0 & 20.0 & 30.0 & 20.0 & 0.0 & 10.0 & 20.0 & 10.0\\20.0 & 10.0 & 20.0 & 30.0 & 10.0 & 0.0 & 10.0 & 20.0\\30.0 & 20.0 & 10.0 & 20.0 & 20.0 & 10.0 & 0.0 & 10.0\\20.0 & 30.0 & 20.0 & 10.0 & 10.0 & 20.0 & 10.0 & 0.0\end{matrix}\right)$$
このとき、円周上に並べた頂点からkamada-kawai法により頂点座標の最適化を行なうと、次のようになる。
$$P = \left(\begin{matrix}-8.67793684189026 & 8.5415530473572\\0.615330753871551 & 0.566612667971006\\10.4534098289126 & 2.5634986383897\\1.94663246078587 & 10.7003160502066\\-13.3302288978483 & -2.27235286708957\\-4.82346184142733 & -10.4091926910052\\5.80113139079798 & -8.25042489484449\\-3.49214770365096 & -0.275483597631729\end{matrix}\right)$$

プロットした画像は次のようになる。

![最適化前](pics/cube_before.png)
![最適化後](pics/cube_after.png)



