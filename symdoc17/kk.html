<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta http-equiv="Content-Style-Type" content="text/css" />
  <meta name="generator" content="pandoc" />
  <title>Network Optimisation</title>
  <style type="text/css">code{white-space: pre;}</style>
  <script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS_CHTML-full" type="text/javascript"></script>
</head>
<body>
<div id="header">
<h1 class="title">Network Optimisation</h1>
</div>
<h1 id="力学モデルを用いたグラフ描画">力学モデルを用いたグラフ描画</h1>
<p>グラフを描画する際、頂点の配置をどのようにするかということは視覚的な理解に大きな影響を及ぼす。 本記事では、グラフの頂点と辺に仮想的な力を割り当て、力学的エネルギーの低い安定状態を探して グラフのレイアウトを求める<strong>kamada-kawai</strong>法を用いる。</p>
<h2 id="力学的エネルギーの定義">力学的エネルギーの定義</h2>
<p>まず、グラフの全頂点がばねで結ばれていると仮定すると、系全体の力学的エネルギーは次で表される。 <span class="math display">\[E = \frac{1}{2} \sum_{\substack{0 \leq i \leq n - 1\\0 \leq j \leq n - 1}} \frac{k_{i,j}}{2} \left(\sqrt{\left(P_{i,0} - P_{j,0}\right)^{2} + \left(P_{i,1} - P_{j,1}\right)^{2}} - l_{i,j}\right)^{2}\]</span> ただし、<span class="math inline">\(P_{i,d}\)</span>はi番目の頂点の座標の第<span class="math inline">\(j\)</span>成分、<span class="math inline">\(k_{i,j},l_{i,j}\)</span>はそれぞれ頂点<span class="math inline">\(i\)</span>と頂点<span class="math inline">\(j\)</span>の間のばね定数、自然長とする。</p>
<p><span class="math inline">\(k_{i,j},l_{i,j}\)</span>は、<span class="math inline">\(d_{i,j}\)</span>を頂点<span class="math inline">\(i\)</span>と頂点<span class="math inline">\(j\)</span>を結ぶ最短経路の長さとして <span class="math display">\[k_{i,j} = K / d_{i,j}^2 (i \neq j) \ \  0(i = j)\]</span> <span class="math display">\[l_{i,j} = L \times d_{i,j}\]</span> で定める(<span class="math inline">\(K,L\)</span>は定数)。</p>
<p><span class="math inline">\(d_{i,j}\)</span>は<strong>Warshall-Floyd</strong>のアルゴリズムにより求めることができる。</p>
<h2 id="エネルギーの最小化">エネルギーの最小化</h2>
<p>例として、頂点数がn,次元が2であるときを考える。 力学的エネルギーが最小になる点では、<span class="math inline">\(gradE = \vec 0\)</span>が成り立つ。すなわち、変数が<span class="math inline">\(2 n\)</span>個ある<span class="math inline">\(2 n\)</span>本の非線型連立方程式を解けばよいのだが、これを解析的に解くのは難しい。 そこで、次のような方法で近似解を求める。</p>
<p>1:まず、特定の頂点1つに着目し、他の頂点の位置を固定する。</p>
<p>2:そして、Newton-Raphson法により選んだ頂点の座標について力学的エネルギー<span class="math inline">\(E\)</span>の最小化を行う。</p>
<p>3:着目する頂点を変えて1,2を繰り返す。</p>
<p>4:<span class="math inline">\(gradE\)</span>が十分小さくなったら終了、その時の座標の値を解とする。</p>
<p>以下で、その具体的な方法について述べる。</p>
<h2 id="近似解の導出">近似解の導出</h2>
<p>選んだ頂点をmとし、その座標を<span class="math inline">\(P_m = \left(\begin{matrix}x_{0} &amp; x_{1}\end{matrix}\right)\)</span>とする。 このときNewton-Raphson法による反復式は、変数を<span class="math inline">\(\left(\begin{matrix}x_{0} &amp; x_{1}\end{matrix}\right)\)</span>としたときのEの1次導関数を<span class="math inline">\(J_m\)</span>、2次導関数を<span class="math inline">\(H_m\)</span>として <span class="math display">\[H_m \left(\begin{matrix}\Delta x_{0}\\\Delta x_{1}\end{matrix}\right) = -J_m\]</span> により表される。 これは2元連立1次方程式となり容易に解けて変位<span class="math inline">\(\Delta P_i = \left(\begin{matrix}\Delta x_{0} &amp; \Delta x_{1}\end{matrix}\right)\)</span>が求められるので、<span class="math inline">\(P_i = P_i + \Delta P_i\)</span>により座標を更新する。 以上を繰り返し、変位が十分小さくなったら操作を終了する。</p>
<p>例えば、<span class="math inline">\(m=0\)</span>だとすると、反復式は <span class="math display">\[\left(\begin{matrix}\sum_{i=1}^{n} \left(1 - \frac{l_{i,0}}{\sqrt{P_{i,0}^{2} - 2 P_{i,0} x_{0} + P_{i,1}^{2} - 2 P_{i,1} x_{1} + x_{0}^{2} + x_{1}^{2}}} + \frac{P_{i,0}^{2} l_{i,0}}{\left(P_{i,0}^{2} - 2 P_{i,0} x_{0} + P_{i,1}^{2} - 2 P_{i,1} x_{1} + x_{0}^{2} + x_{1}^{2}\right)^{\frac{3}{2}}} - \frac{2 P_{i,0} l_{i,0} x_{0}}{\left(P_{i,0}^{2} - 2 P_{i,0} x_{0} + P_{i,1}^{2} - 2 P_{i,1} x_{1} + x_{0}^{2} + x_{1}^{2}\right)^{\frac{3}{2}}} + \frac{l_{i,0} x_{0}^{2}}{\left(P_{i,0}^{2} - 2 P_{i,0} x_{0} + P_{i,1}^{2} - 2 P_{i,1} x_{1} + x_{0}^{2} + x_{1}^{2}\right)^{\frac{3}{2}}}\right) k_{i,0} &amp; \sum_{i=1}^{n} \left(\frac{P_{i,0} P_{i,1} l_{i,0}}{\left(P_{i,0}^{2} - 2 P_{i,0} x_{0} + P_{i,1}^{2} - 2 P_{i,1} x_{1} + x_{0}^{2} + x_{1}^{2}\right)^{\frac{3}{2}}} - \frac{P_{i,0} l_{i,0} x_{1}}{\left(P_{i,0}^{2} - 2 P_{i,0} x_{0} + P_{i,1}^{2} - 2 P_{i,1} x_{1} + x_{0}^{2} + x_{1}^{2}\right)^{\frac{3}{2}}} - \frac{P_{i,1} l_{i,0} x_{0}}{\left(P_{i,0}^{2} - 2 P_{i,0} x_{0} + P_{i,1}^{2} - 2 P_{i,1} x_{1} + x_{0}^{2} + x_{1}^{2}\right)^{\frac{3}{2}}} + \frac{l_{i,0} x_{0} x_{1}}{\left(P_{i,0}^{2} - 2 P_{i,0} x_{0} + P_{i,1}^{2} - 2 P_{i,1} x_{1} + x_{0}^{2} + x_{1}^{2}\right)^{\frac{3}{2}}}\right) k_{i,0}\\\sum_{i=1}^{n} \left(\frac{P_{i,0} P_{i,1} l_{i,0}}{\left(P_{i,0}^{2} - 2 P_{i,0} x_{0} + P_{i,1}^{2} - 2 P_{i,1} x_{1} + x_{0}^{2} + x_{1}^{2}\right)^{\frac{3}{2}}} - \frac{P_{i,0} l_{i,0} x_{1}}{\left(P_{i,0}^{2} - 2 P_{i,0} x_{0} + P_{i,1}^{2} - 2 P_{i,1} x_{1} + x_{0}^{2} + x_{1}^{2}\right)^{\frac{3}{2}}} - \frac{P_{i,1} l_{i,0} x_{0}}{\left(P_{i,0}^{2} - 2 P_{i,0} x_{0} + P_{i,1}^{2} - 2 P_{i,1} x_{1} + x_{0}^{2} + x_{1}^{2}\right)^{\frac{3}{2}}} + \frac{l_{i,0} x_{0} x_{1}}{\left(P_{i,0}^{2} - 2 P_{i,0} x_{0} + P_{i,1}^{2} - 2 P_{i,1} x_{1} + x_{0}^{2} + x_{1}^{2}\right)^{\frac{3}{2}}}\right) k_{i,0} &amp; \sum_{i=1}^{n} \left(1 - \frac{l_{i,0}}{\sqrt{P_{i,0}^{2} - 2 P_{i,0} x_{0} + P_{i,1}^{2} - 2 P_{i,1} x_{1} + x_{0}^{2} + x_{1}^{2}}} + \frac{P_{i,1}^{2} l_{i,0}}{\left(P_{i,0}^{2} - 2 P_{i,0} x_{0} + P_{i,1}^{2} - 2 P_{i,1} x_{1} + x_{0}^{2} + x_{1}^{2}\right)^{\frac{3}{2}}} - \frac{2 P_{i,1} l_{i,0} x_{1}}{\left(P_{i,0}^{2} - 2 P_{i,0} x_{0} + P_{i,1}^{2} - 2 P_{i,1} x_{1} + x_{0}^{2} + x_{1}^{2}\right)^{\frac{3}{2}}} + \frac{l_{i,0} x_{1}^{2}}{\left(P_{i,0}^{2} - 2 P_{i,0} x_{0} + P_{i,1}^{2} - 2 P_{i,1} x_{1} + x_{0}^{2} + x_{1}^{2}\right)^{\frac{3}{2}}}\right) k_{i,0}\end{matrix}\right)\left(\begin{matrix}\Delta x_{0}\\\Delta x_{1}\end{matrix}\right) = -\left(\begin{matrix}\sum_{i=1}^{n} \left(- P_{i,0} + x_{0} + \frac{P_{i,0} l_{i,0}}{\sqrt{P_{i,0}^{2} - 2 P_{i,0} x_{0} + P_{i,1}^{2} - 2 P_{i,1} x_{1} + x_{0}^{2} + x_{1}^{2}}} - \frac{l_{i,0} x_{0}}{\sqrt{P_{i,0}^{2} - 2 P_{i,0} x_{0} + P_{i,1}^{2} - 2 P_{i,1} x_{1} + x_{0}^{2} + x_{1}^{2}}}\right) k_{i,0}\\\sum_{i=1}^{n} \left(- P_{i,1} + x_{1} + \frac{P_{i,1} l_{i,0}}{\sqrt{P_{i,0}^{2} - 2 P_{i,0} x_{0} + P_{i,1}^{2} - 2 P_{i,1} x_{1} + x_{0}^{2} + x_{1}^{2}}} - \frac{l_{i,0} x_{1}}{\sqrt{P_{i,0}^{2} - 2 P_{i,0} x_{0} + P_{i,1}^{2} - 2 P_{i,1} x_{1} + x_{0}^{2} + x_{1}^{2}}}\right) k_{i,0}\end{matrix}\right) \]</span> となる。</p>
<p>選んだ頂点の最適化が終わったら、別な頂点を選んで上記の最適化を繰り返す。 <span class="math inline">\(max_i \sqrt{\left(\frac{d}{d P_{i,0}} E{\left (P_{i,0} \right )}\right)^{2} + \left(\frac{d}{d P_{i,1}} E{\left (P_{i,1} \right )}\right)^{2}}\)</span>が十分小さくなったら更新を終了してその時の座標を力学的エネルギー<span class="math inline">\(E\)</span>が最小となる解とする。</p>
<h2 id="グラフdouble_triangleの描画">グラフdouble_triangleの描画</h2>
<p>頂点を['0', '1', '2', '3', '4', '5']、隣接する点のリストを[&quot;['2', '3']&quot;, &quot;['4', '5']&quot;, &quot;['0', '3', '5']&quot;, &quot;['0', '2']&quot;, &quot;['1', '5']&quot;, &quot;['1', '2', '4']&quot;]とすると、最短経路行列<span class="math inline">\(D\)</span>,ばね定数行列<span class="math inline">\(K\)</span>,自然長行列<span class="math inline">\(L\)</span>は次のようになる。 <span class="math display">\[D = \left(\begin{matrix}0.0 &amp; 3.0 &amp; 1.0 &amp; 1.0 &amp; 3.0 &amp; 2.0\\3.0 &amp; 0.0 &amp; 2.0 &amp; 3.0 &amp; 1.0 &amp; 1.0\\1.0 &amp; 2.0 &amp; 0.0 &amp; 1.0 &amp; 2.0 &amp; 1.0\\1.0 &amp; 3.0 &amp; 1.0 &amp; 0.0 &amp; 3.0 &amp; 2.0\\3.0 &amp; 1.0 &amp; 2.0 &amp; 3.0 &amp; 0.0 &amp; 1.0\\2.0 &amp; 1.0 &amp; 1.0 &amp; 2.0 &amp; 1.0 &amp; 0.0\end{matrix}\right),K = \left(\begin{matrix}0.0 &amp; 1.11111111111111 &amp; 10.0 &amp; 10.0 &amp; 1.11111111111111 &amp; 2.5\\1.11111111111111 &amp; 0.0 &amp; 2.5 &amp; 1.11111111111111 &amp; 10.0 &amp; 10.0\\10.0 &amp; 2.5 &amp; 0.0 &amp; 10.0 &amp; 2.5 &amp; 10.0\\10.0 &amp; 1.11111111111111 &amp; 10.0 &amp; 0.0 &amp; 1.11111111111111 &amp; 2.5\\1.11111111111111 &amp; 10.0 &amp; 2.5 &amp; 1.11111111111111 &amp; 0.0 &amp; 10.0\\2.5 &amp; 10.0 &amp; 10.0 &amp; 2.5 &amp; 10.0 &amp; 0.0\end{matrix}\right),L = \left(\begin{matrix}0.0 &amp; 30.0 &amp; 10.0 &amp; 10.0 &amp; 30.0 &amp; 20.0\\30.0 &amp; 0.0 &amp; 20.0 &amp; 30.0 &amp; 10.0 &amp; 10.0\\10.0 &amp; 20.0 &amp; 0.0 &amp; 10.0 &amp; 20.0 &amp; 10.0\\10.0 &amp; 30.0 &amp; 10.0 &amp; 0.0 &amp; 30.0 &amp; 20.0\\30.0 &amp; 10.0 &amp; 20.0 &amp; 30.0 &amp; 0.0 &amp; 10.0\\20.0 &amp; 10.0 &amp; 10.0 &amp; 20.0 &amp; 10.0 &amp; 0.0\end{matrix}\right)\]</span> このとき、円周上に並べた頂点からkamada-kawai法により頂点座標の最適化を行なうと、次のようになる。 <span class="math display">\[P = \left(\begin{matrix}-8.77208279962894 &amp; -5.29446908003263\\12.9512046492833 &amp; 15.3686801822484\\-2.65225621175079 &amp; 2.89643427341546\\-12.8434386880317 &amp; 3.722525864464\\17.0222086631959 &amp; 6.35156426510948\\6.83100383320914 &amp; 7.17809368168207\end{matrix}\right)\]</span></p>
<p>プロットした画像は次のようになる。</p>
<p><img src="pics/double_triangle_before.png" alt="最適化前" /> <img src="pics/double_triangle_after.png" alt="最適化後" /></p>
<h2 id="グラフcubeの描画">グラフcubeの描画</h2>
<p>頂点を['0', '1', '2', '3', '4', '5', '6', '7']、隣接する点のリストを[&quot;['1', '3', '4']&quot;, &quot;['0', '2', '5']&quot;, &quot;['1', '3', '6']&quot;, &quot;['0', '2', '7']&quot;, &quot;['0', '5', '7']&quot;, &quot;['1', '4', '6']&quot;, &quot;['2', '5', '7']&quot;, &quot;['3', '4', '6']&quot;]とすると、最短経路行列<span class="math inline">\(D\)</span>,ばね定数行列<span class="math inline">\(K\)</span>,自然長行列<span class="math inline">\(L\)</span>は次のようになる。 <span class="math display">\[D = \left(\begin{matrix}0.0 &amp; 1.0 &amp; 2.0 &amp; 1.0 &amp; 1.0 &amp; 2.0 &amp; 3.0 &amp; 2.0\\1.0 &amp; 0.0 &amp; 1.0 &amp; 2.0 &amp; 2.0 &amp; 1.0 &amp; 2.0 &amp; 3.0\\2.0 &amp; 1.0 &amp; 0.0 &amp; 1.0 &amp; 3.0 &amp; 2.0 &amp; 1.0 &amp; 2.0\\1.0 &amp; 2.0 &amp; 1.0 &amp; 0.0 &amp; 2.0 &amp; 3.0 &amp; 2.0 &amp; 1.0\\1.0 &amp; 2.0 &amp; 3.0 &amp; 2.0 &amp; 0.0 &amp; 1.0 &amp; 2.0 &amp; 1.0\\2.0 &amp; 1.0 &amp; 2.0 &amp; 3.0 &amp; 1.0 &amp; 0.0 &amp; 1.0 &amp; 2.0\\3.0 &amp; 2.0 &amp; 1.0 &amp; 2.0 &amp; 2.0 &amp; 1.0 &amp; 0.0 &amp; 1.0\\2.0 &amp; 3.0 &amp; 2.0 &amp; 1.0 &amp; 1.0 &amp; 2.0 &amp; 1.0 &amp; 0.0\end{matrix}\right),K = \left(\begin{matrix}0.0 &amp; 10.0 &amp; 2.5 &amp; 10.0 &amp; 10.0 &amp; 2.5 &amp; 1.11111111111111 &amp; 2.5\\10.0 &amp; 0.0 &amp; 10.0 &amp; 2.5 &amp; 2.5 &amp; 10.0 &amp; 2.5 &amp; 1.11111111111111\\2.5 &amp; 10.0 &amp; 0.0 &amp; 10.0 &amp; 1.11111111111111 &amp; 2.5 &amp; 10.0 &amp; 2.5\\10.0 &amp; 2.5 &amp; 10.0 &amp; 0.0 &amp; 2.5 &amp; 1.11111111111111 &amp; 2.5 &amp; 10.0\\10.0 &amp; 2.5 &amp; 1.11111111111111 &amp; 2.5 &amp; 0.0 &amp; 10.0 &amp; 2.5 &amp; 10.0\\2.5 &amp; 10.0 &amp; 2.5 &amp; 1.11111111111111 &amp; 10.0 &amp; 0.0 &amp; 10.0 &amp; 2.5\\1.11111111111111 &amp; 2.5 &amp; 10.0 &amp; 2.5 &amp; 2.5 &amp; 10.0 &amp; 0.0 &amp; 10.0\\2.5 &amp; 1.11111111111111 &amp; 2.5 &amp; 10.0 &amp; 10.0 &amp; 2.5 &amp; 10.0 &amp; 0.0\end{matrix}\right),L = \left(\begin{matrix}0.0 &amp; 10.0 &amp; 20.0 &amp; 10.0 &amp; 10.0 &amp; 20.0 &amp; 30.0 &amp; 20.0\\10.0 &amp; 0.0 &amp; 10.0 &amp; 20.0 &amp; 20.0 &amp; 10.0 &amp; 20.0 &amp; 30.0\\20.0 &amp; 10.0 &amp; 0.0 &amp; 10.0 &amp; 30.0 &amp; 20.0 &amp; 10.0 &amp; 20.0\\10.0 &amp; 20.0 &amp; 10.0 &amp; 0.0 &amp; 20.0 &amp; 30.0 &amp; 20.0 &amp; 10.0\\10.0 &amp; 20.0 &amp; 30.0 &amp; 20.0 &amp; 0.0 &amp; 10.0 &amp; 20.0 &amp; 10.0\\20.0 &amp; 10.0 &amp; 20.0 &amp; 30.0 &amp; 10.0 &amp; 0.0 &amp; 10.0 &amp; 20.0\\30.0 &amp; 20.0 &amp; 10.0 &amp; 20.0 &amp; 20.0 &amp; 10.0 &amp; 0.0 &amp; 10.0\\20.0 &amp; 30.0 &amp; 20.0 &amp; 10.0 &amp; 10.0 &amp; 20.0 &amp; 10.0 &amp; 0.0\end{matrix}\right)\]</span> このとき、円周上に並べた頂点からkamada-kawai法により頂点座標の最適化を行なうと、次のようになる。 <span class="math display">\[P = \left(\begin{matrix}-8.67793684189026 &amp; 8.5415530473572\\0.615330753871551 &amp; 0.566612667971006\\10.4534098289126 &amp; 2.5634986383897\\1.94663246078587 &amp; 10.7003160502066\\-13.3302288978483 &amp; -2.27235286708957\\-4.82346184142733 &amp; -10.4091926910052\\5.80113139079798 &amp; -8.25042489484449\\-3.49214770365096 &amp; -0.275483597631729\end{matrix}\right)\]</span></p>
<p>プロットした画像は次のようになる。</p>
<p><img src="pics/cube_before.png" alt="最適化前" /> <img src="pics/cube_after.png" alt="最適化後" /></p>
</body>
</html>
